# AI智能定时任务插件

这是一个为AstrBot开发的智能定时任务插件，它可以帮助用户设置智能化的定时提醒和自动执行任务，并支持与AI进行自然语言交互。

## 功能特点

- 支持设置一次性或重复性的定时提醒
- 支持设置自动执行任务，到时间后AI会自动执行指定操作
- 支持设置指令任务，到时间后直接执行指定指令并转发结果
- 支持调用其他LLM函数，实现更复杂的自动化任务
- AI智能化提醒，生成自然语言的提醒内容
- 支持多种重复模式：每天、每周、每月、每年
- 支持法定节假日判断，可设置仅在工作日或节假日触发的提醒和任务
- 支持会话隔离，群聊中每个成员可以有独立的提醒和任务
- 简单的命令管理系统
- 持久化存储提醒和任务数据

## 安装方法

1. 将插件文件夹 `astrbot_plugin_sy` 复制到 AstrBot 的 plugins 目录下
2. 重启 AstrBot

## 使用方法

### 设置提醒

插件会注册为AI工具，可以直接用自然语言设置提醒，例如：
- "帮我设置一个提醒，明天早上8点提醒我去上班"
- "每天晚上10点提醒我睡觉"
- "每个工作日早上8点提醒我打卡"

### 设置任务

除了提醒外，还可以设置任务，让AI在指定时间自动执行操作：
- "设置一个任务，明天早上8点发送今日天气预报"
- "每天中午12点帮我汇总今日新闻"
- "每个天下午5点提醒所有人下班，工作日触发"
- "帮我删了之前布置的开会任务"

### 设置指令任务

指令任务是一种特殊的任务类型，不需要AI处理，直接执行指定的指令：
- 可以定时执行其他插件的指令，如获取配置、查看状态等
- 执行结果会直接转发给用户
- 不消耗LLM资源，执行效率更高
- 支持复杂指令，使用 `--` 分隔符避免指令被错误解析
- 优化了执行等待时间，支持长时间运行的指令（最多等待20秒）

### 命令列表

插件提供以下命令用于管理提醒和任务：

1. 添加提醒：
/rmd add <内容> <时间> [开始星期] [重复类型] [--holiday_type=...]
例如：
- `/rmd add 写周报 8:05 mon weekly`
- `/rmd add 上班打卡 8:30 daily workday`（每个工作日）
- `/rmd add 休息提醒 9:00 daily holiday`（每个法定节假日）

2. 添加任务：
/rmd task <内容> <时间> [开始星期] [重复类型] [--holiday_type=...]
例如：
- `/rmd task 发送天气预报 8:00 daily`
- `/rmd task 工作安排 9:00 mon weekly workday`（每周一工作日）

3. 添加指令任务：
/rmd command <指令> <时间> [开始星期] [重复类型] [--holiday_type=...]
例如：
- `/rmd command /weather 9:00 daily`（每天9点获取天气）
- `/rmd command /news 18:00 mon weekly`（每周一18点获取新闻）
- `/rmd command /rmd--ls 8:00 daily`（使用--避免指令被错误分割）
- `/rmd command /complex--command 10:00`（执行复杂指令，最多等待20秒）

1. 查看所有提醒和任务：
/rmd ls

1. 删除指定提醒或任务：
/rmd rm <序号>
例如：删除第1个提醒 `/rmd rm 1`

1. 查看帮助信息：
/rmd help

### 使用演示

![提醒演示](https://sywb.top/Staticfiles/pic/ys1.png)
![自动执行任务](https://sywb.top/Staticfiles/pic/ys3.png)
![自动执行任务2](https://sywb.top/Staticfiles/pic/ys5.png)
![指令任务](https://sywb.top/Staticfiles/pic/ys6.png)
![复杂指令](https://sywb.top/Staticfiles/pic/ys7.png)
![人性化回复](https://sywb.top/Staticfiles/pic/ys4.png)

### 重复类型说明

提醒和任务支持以下重复类型：
- `none`: 一次性（默认）
- `daily`: 每天重复
- `weekly`: 每周重复
- `monthly`: 每月重复
- `yearly`: 每年重复

### 节假日类型说明

在重复类型的基础上，还可以指定节假日类型：
- `workday`: 仅在工作日触发（法定节假日不触发）
- `holiday`: 仅在法定节假日触发

## 会话隔离功能

### 什么是会话隔离？

会话隔离功能使群聊中的每个成员都能拥有自己独立的提醒和任务列表，其他成员无法看到或操作。

- **关闭状态**：群聊中所有成员共享同一组提醒和任务列表
- **开启状态**：群聊中每个成员都有自己独立的提醒和任务列表

### 如何启用会话隔离？

会话隔离功能默认关闭，可以通过管理面板的插件配置开启：

1. 进入AstrBot管理面板
2. 找到"插件管理">"本插件"
3. 点击"配置"按钮
4. 将"启用会话隔离"选项勾选，然后保存

**注意**：切换会话隔离模式不会导致数据丢失，只会改变提醒和任务的可见性。

## 配置说明

插件会在 `data/reminders/` 目录下自动创建 `reminder_data.json` 文件用于存储提醒和任务数据。

### 插件配置

插件支持以下配置选项，可通过管理面板进行设置：

- **启用会话隔离**：群聊中每个成员拥有独立的提醒和任务列表
- **启用上下文功能**：使用用户对话上下文生成更自然的提醒内容
- **关闭上下文时的提示词模板**：自定义禁用上下文时的提醒提示词
- **最大上下文数量**：限制使用的对话上下文条数（默认5条）

配置保存在 `data/config/ai_reminder_config.json` 文件中，也可通过管理面板配置。

法定节假日数据会缓存在 `data/holiday_data/holiday_cache.json` 文件中，缓存期为30天，过期后会自动更新。

## 提醒与任务的区别

- **提醒**：到时间后会提醒用户做某事，例如"提醒我去开会"
- **任务**：到时间后AI会自动执行指定的操作，例如"发送天气预报"或"调用某个函数"
- **指令任务**：到时间后直接执行指定的指令并转发结果，不需要AI处理，例如"/memory_config"

## 指令任务高级用法

### 复杂指令支持
当指令包含空格时，系统可能会错误解析。使用 `--` 分隔符可以避免这个问题：

```bash
# 错误的方式（会被错误解析为 /rmd）
/rmd command /rmd ls 08:01 daily

# 正确的方式（完整指令 /rmd ls）
/rmd command /rmd--ls 08:01 daily
```

### 长时间执行支持
指令任务现在支持最多20秒的执行时间，适合以下场景：
- 需要调用外部API的指令
- 需要处理大量数据的指令
- 需要生成复杂内容的指令
- 网络延迟较高的环境

### 执行结果转发
指令执行完成后，结果会自动转发给用户，包括：
- 文本消息
- 图片、文件等多媒体内容
- 错误信息（如果执行失败）

## 法定节假日数据来源

法定节假日数据使用第三方API获取：http://timor.tech/api/holiday
数据会在本地缓存，避免频繁调用API。

## 依赖要求

- AstrBot 框架 v3.4.15+（会话隔离功能需要此版本以上）
- APScheduler
- Python 3.7+
- aiohttp（用于获取节假日数据）

## 作者

- 作者：kjqwdw
- 版本：v1.2.5

## 支持

如需帮助，请参考 [AstrBot插件开发文档](https://astrbot.soulter.top/center/docs/%E5%BC%80%E5%8F%91/%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/)

## 问题反馈

如有问题或建议，请访问以下地址反馈：
[反馈](https://github.com/kjqwer/astrbot_plugin_sy/issues)
